<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIP ALG Test Tool - Check Your Network</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #667eea;
            font-size: 1.5em;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .info-box h3 {
            color: #667eea;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .info-box p, .info-box ul {
            color: #555;
            line-height: 1.6;
        }

        .info-box ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .info-box li {
            margin-bottom: 8px;
        }

        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            max-width: 400px;
            display: block;
            margin: 30px auto;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }

        .test-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .test-button:active:not(:disabled) {
            transform: translateY(0);
        }

        .test-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .results-container {
            display: none;
            margin-top: 30px;
        }

        .results-container.show {
            display: block;
        }

        .result-box {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid;
        }

        .result-box.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .result-box.warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .result-box.error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .result-box.info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        .result-box h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .result-box .icon {
            font-size: 1.5em;
            margin-right: 10px;
        }

        .result-box p {
            line-height: 1.6;
            margin-top: 10px;
        }

        .test-details {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
        }

        .test-details h4 {
            color: #495057;
            margin-bottom: 10px;
        }

        .test-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .test-item:last-child {
            border-bottom: none;
        }

        .test-item .label {
            font-weight: 600;
            color: #495057;
        }

        .test-item .value {
            color: #6c757d;
        }

        .test-item .status-pass {
            color: #28a745;
            font-weight: bold;
        }

        .test-item .status-fail {
            color: #dc3545;
            font-weight: bold;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .progress-log .log-line {
            margin-bottom: 5px;
            padding: 3px 0;
        }

        .progress-log .log-success {
            color: #68d391;
        }

        .progress-log .log-error {
            color: #fc8181;
        }

        .progress-log .log-warning {
            color: #f6e05e;
        }

        .progress-log .log-info {
            color: #63b3ed;
        }

        .download-section {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-top: 30px;
        }

        .download-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .download-link {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 12px 30px;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            transition: background 0.3s ease;
            margin: 10px;
        }

        .download-link:hover {
            background: #5568d3;
        }

        .footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            color: #6c757d;
            font-size: 0.9em;
            border-top: 1px solid #dee2e6;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5em;
            }

            .content {
                padding: 20px;
            }

            .test-button {
                padding: 15px 30px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç SIP ALG Test Tool</h1>
            <p>Test if your network has SIP ALG enabled</p>
        </div>

        <div class="content">
            <div class="section">
                <h2>What is SIP ALG?</h2>
                <div class="info-box">
                    <p>
                        <strong>SIP ALG (Application Layer Gateway)</strong> is a feature in routers that attempts to help with VoIP calls. 
                        However, it often causes more problems than it solves, leading to:
                    </p>
                    <ul>
                        <li>Poor call quality or dropped calls</li>
                        <li>One-way audio (you can hear them, but they can't hear you)</li>
                        <li>Calls that won't connect properly</li>
                        <li>Registration failures with your VoIP provider</li>
                    </ul>
                    <p style="margin-top: 15px;">
                        <strong>This tool helps you check if SIP ALG is interfering with your VoIP connection.</strong>
                    </p>
                </div>
            </div>

            <div class="section">
                <h2>How to Use This Tool</h2>
                <div class="info-box">
                    <h3>Simple 3-Step Process:</h3>
                    <ul>
                        <li><strong>Step 1:</strong> Click the "Run Test" button below</li>
                        <li><strong>Step 2:</strong> Wait 10-15 seconds for the test to complete</li>
                        <li><strong>Step 3:</strong> Review the results and follow the recommendations</li>
                    </ul>
                    <p style="margin-top: 15px;">
                        <strong>Note:</strong> This test checks connectivity to our test server at <code>193.105.36.4</code>.
                        The test is completely safe and only checks if your router is blocking or modifying SIP traffic.
                    </p>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        <strong>Technical Note:</strong> Due to browser security, this test checks TCP connectivity to SIP/RTP port numbers 
                        (which normally use UDP for VoIP). While not a perfect test, blocked TCP ports typically indicate firewall 
                        rules that would also affect UDP traffic on the same ports.
                    </p>
                </div>
            </div>

            <button class="test-button" id="testButton" onclick="runTest()">
                üöÄ Run SIP ALG Test
            </button>

            <div class="results-container" id="resultsContainer">
                <div class="section">
                    <h2>Test Results</h2>
                    <div id="resultsContent"></div>
                </div>
            </div>

            <div class="section download-section">
                <h3>üì• Advanced Testing</h3>
                <p style="margin-bottom: 15px;">
                    For more detailed analysis, download our Python script for advanced testing:
                </p>
                <a href="https://raw.githubusercontent.com/gauthiervq-sys/Sip-ALG-checker/main/sip_alg_checker.py" 
                   class="download-link" download>
                    Download Python Script
                </a>
                <a href="https://github.com/gauthiervq-sys/Sip-ALG-checker" 
                   class="download-link" target="_blank">
                    View on GitHub
                </a>
            </div>
        </div>

        <div class="footer">
            <p>SIP ALG Checker Tool | Open Source | <a href="https://github.com/gauthiervq-sys/Sip-ALG-checker" target="_blank">GitHub Repository</a></p>
            <p style="margin-top: 10px;">This tool performs connectivity tests only and does not collect any personal data.</p>
        </div>
    </div>

    <script>
        const TEST_SERVER = '193.105.36.4';
        const SIP_PORT = 5060;
        const RTP_PORTS = [10000, 12000, 14000, 16000, 18000];
        
        let testResults = {
            sipConnectivity: null,
            rtpConnectivity: [],
            latency: null,
            timestamp: null
        };

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('progressLog');
            if (!logContainer) return;
            
            const logLine = document.createElement('div');
            logLine.className = `log-line log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            logLine.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logLine);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function testWebSocketConnection(port, timeout = 5000) {
            return new Promise((resolve) => {
                const startTime = Date.now();
                
                // IMPORTANT: Browser security restrictions prevent direct UDP port testing
                // This test uses HTTP/TCP as a proxy indicator for network accessibility
                // SIP (5060) and RTP ports (10000-20000) typically use UDP, but we test
                // TCP connectivity to these port numbers as an indicator of firewall rules
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                let wasAborted = false;
                
                fetch(`http://${TEST_SERVER}:${port}`, {
                    method: 'HEAD',
                    mode: 'no-cors',
                    signal: controller.signal
                })
                .then(() => {
                    clearTimeout(timeoutId);
                    const latency = Date.now() - startTime;
                    resolve({ success: true, latency });
                })
                .catch((error) => {
                    clearTimeout(timeoutId);
                    const latency = Date.now() - startTime;
                    // Check if error was due to timeout/abort
                    wasAborted = error.name === 'AbortError';
                    // In no-cors mode, network errors complete quickly
                    // Timeouts indicate the port might be filtered
                    resolve({ success: !wasAborted && latency < timeout * 0.8, latency, error: error.message });
                });
            });
        }

        async function testICMPPing() {
            // Browser doesn't support ICMP, so we simulate with HTTP request
            const startTime = Date.now();
            try {
                await fetch(`http://${TEST_SERVER}`, {
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                const latency = Date.now() - startTime;
                return { success: true, latency };
            } catch (error) {
                const latency = Date.now() - startTime;
                return { success: latency < 3000, latency };
            }
        }

        function analyzeResults() {
            const analysis = {
                algLikelihood: 'UNKNOWN',
                severity: 'info',
                title: '',
                message: '',
                recommendations: []
            };

            // Check if server is reachable
            if (!testResults.sipConnectivity || !testResults.sipConnectivity.success) {
                analysis.algLikelihood = 'CANNOT_DETERMINE';
                analysis.severity = 'warning';
                analysis.title = '‚ö†Ô∏è Cannot Reach Test Server';
                analysis.message = `Unable to connect to the test server at ${TEST_SERVER}. This could mean:`;
                analysis.recommendations = [
                    'Your internet connection may be down or unstable',
                    'Your firewall is blocking all traffic to the test server',
                    'The test server may be temporarily unavailable',
                    'Your ISP may be blocking VoIP traffic completely'
                ];
                return analysis;
            }

            // Analyze connectivity patterns
            const sipAccessible = testResults.sipConnectivity.success;
            const rtpSuccessCount = testResults.rtpConnectivity.filter(r => r.success).length;
            const rtpTotalCount = testResults.rtpConnectivity.length;

            if (sipAccessible && rtpSuccessCount >= 4) {
                analysis.algLikelihood = 'UNLIKELY';
                analysis.severity = 'success';
                analysis.title = '‚úÖ No SIP ALG Detected';
                analysis.message = 'Great news! Your network appears to be properly configured for VoIP. SIP and RTP ports are accessible, which suggests SIP ALG is not interfering with your connection.';
                analysis.recommendations = [
                    'Your router configuration looks good for VoIP calls',
                    'If you still experience call quality issues, they may be due to other factors like bandwidth or network congestion',
                    'Consider running the advanced Python script for more detailed network quality analysis'
                ];
            } else if (!sipAccessible || rtpSuccessCount < 2) {
                analysis.algLikelihood = 'LIKELY';
                analysis.severity = 'error';
                analysis.title = 'üö´ SIP ALG Likely Active';
                analysis.message = `SIP ALG appears to be interfering with your VoIP traffic. The test shows limited connectivity to SIP/RTP ports, which is a strong indicator that your router is blocking or modifying VoIP packets.`;
                analysis.recommendations = [
                    '<strong>Disable SIP ALG in your router:</strong> Log into your router (common addresses: 192.168.1.1, 192.168.0.1, 192.168.2.1, 10.0.0.1, or check your network settings) and look for SIP ALG settings under Advanced ‚Üí NAT or Firewall ‚Üí ALG',
                    'After disabling SIP ALG, reboot your router',
                    'Run this test again to confirm SIP ALG is disabled',
                    'If you cannot find SIP ALG settings, consult your router\'s manual or contact your ISP',
                    'Some ISPs block VoIP traffic - if problems persist, contact your ISP'
                ];
            } else {
                analysis.algLikelihood = 'POSSIBLE';
                analysis.severity = 'warning';
                analysis.title = '‚ö†Ô∏è Possible SIP ALG Interference';
                analysis.message = 'The test results are inconclusive. SIP ALG may be partially active or there might be other network configuration issues affecting VoIP connectivity.';
                analysis.recommendations = [
                    'Try disabling SIP ALG in your router if the option exists',
                    'Check if your firewall is blocking UDP ports 5060 and 10000-20000',
                    'Run the advanced Python script for more detailed analysis',
                    'If experiencing call quality issues, consider contacting your VoIP provider for assistance'
                ];
            }

            return analysis;
        }

        function displayResults(analysis) {
            const resultsContent = document.getElementById('resultsContent');
            const resultsContainer = document.getElementById('resultsContainer');
            
            resultsContent.innerHTML = `
                <div class="result-box ${analysis.severity}">
                    <h3>
                        <span class="icon">${analysis.title.split(' ')[0]}</span>
                        ${analysis.title.substring(analysis.title.indexOf(' ') + 1)}
                    </h3>
                    <p>${analysis.message}</p>
                    
                    ${analysis.recommendations.length > 0 ? `
                        <div style="margin-top: 15px;">
                            <strong>Recommendations:</strong>
                            <ul style="margin-left: 20px; margin-top: 10px;">
                                ${analysis.recommendations.map(rec => `<li style="margin-bottom: 8px;">${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>

                <div class="test-details">
                    <h4>üìä Test Details</h4>
                    <div class="test-item">
                        <span class="label">Test Server:</span>
                        <span class="value">${TEST_SERVER}</span>
                    </div>
                    <div class="test-item">
                        <span class="label">Test Time:</span>
                        <span class="value">${new Date(testResults.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="test-item">
                        <span class="label">SIP Port (5060):</span>
                        <span class="value ${testResults.sipConnectivity.success ? 'status-pass' : 'status-fail'}">
                            ${testResults.sipConnectivity.success ? '‚úì Accessible' : '‚úó Blocked'}
                            ${testResults.sipConnectivity.latency ? ` (${testResults.sipConnectivity.latency}ms)` : ''}
                        </span>
                    </div>
                    <div class="test-item">
                        <span class="label">RTP Ports:</span>
                        <span class="value">
                            ${testResults.rtpConnectivity.filter(r => r.success).length} of ${testResults.rtpConnectivity.length} accessible
                        </span>
                    </div>
                    ${testResults.latency ? `
                        <div class="test-item">
                            <span class="label">Average Latency:</span>
                            <span class="value">${testResults.latency}ms</span>
                        </div>
                    ` : ''}
                </div>

                <div class="result-box info" style="margin-top: 15px;">
                    <h3>
                        <span class="icon">‚ÑπÔ∏è</span>
                        Understanding the Results
                    </h3>
                    <p>
                        <strong>SIP Port 5060:</strong> Used for call signaling (setting up and ending calls)<br>
                        <strong>RTP Ports (10000-20000):</strong> Used for actual voice data during calls<br><br>
                        If these ports are blocked or heavily restricted, it indicates SIP ALG or firewall interference.
                    </p>
                </div>
            `;
            
            resultsContainer.classList.add('show');
        }

        async function runTest() {
            const button = document.getElementById('testButton');
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsContent = document.getElementById('resultsContent');
            
            // Reset results
            testResults = {
                sipConnectivity: null,
                rtpConnectivity: [],
                latency: null,
                timestamp: Date.now()
            };
            
            // Show progress
            button.disabled = true;
            button.innerHTML = 'üîÑ Testing... <span class="spinner"></span>';
            resultsContainer.classList.remove('show');
            
            resultsContent.innerHTML = `
                <div class="result-box info">
                    <h3>
                        <span class="icon">üîÑ</span>
                        Running Tests...
                    </h3>
                    <p>Please wait while we test your network connectivity...</p>
                    <div class="progress-log" id="progressLog"></div>
                </div>
            `;
            resultsContainer.classList.add('show');

            try {
                // Test 1: Ping test
                addLog('Testing basic connectivity to server...', 'info');
                const pingResult = await testICMPPing();
                if (pingResult.success) {
                    addLog(`‚úì Server is reachable (${pingResult.latency}ms)`, 'success');
                    testResults.latency = pingResult.latency;
                } else {
                    addLog('‚úó Server connectivity issue detected', 'warning');
                }
                
                // Test 2: SIP Port
                addLog(`Testing SIP port ${SIP_PORT}...`, 'info');
                testResults.sipConnectivity = await testWebSocketConnection(SIP_PORT, 3000);
                if (testResults.sipConnectivity.success) {
                    addLog('‚úì SIP port accessible', 'success');
                } else {
                    addLog('‚úó SIP port blocked or filtered', 'error');
                }
                
                // Test 3: Sample RTP Ports
                addLog('Testing RTP ports...', 'info');
                for (const port of RTP_PORTS) {
                    const result = await testWebSocketConnection(port, 2000);
                    testResults.rtpConnectivity.push({ port, ...result });
                    if (result.success) {
                        addLog(`‚úì RTP port ${port} accessible`, 'success');
                    } else {
                        addLog(`‚úó RTP port ${port} blocked`, 'error');
                    }
                }
                
                addLog('Analysis complete!', 'success');
                
                // Analyze and display results
                setTimeout(() => {
                    const analysis = analyzeResults();
                    displayResults(analysis);
                }, 500);
                
            } catch (error) {
                addLog(`Error during testing: ${error.message}`, 'error');
                resultsContent.innerHTML = `
                    <div class="result-box error">
                        <h3>
                            <span class="icon">‚ùå</span>
                            Test Error
                        </h3>
                        <p>An error occurred while running the test: ${error.message}</p>
                        <p style="margin-top: 10px;">Please try again or use the advanced Python script for testing.</p>
                    </div>
                `;
            } finally {
                button.disabled = false;
                button.innerHTML = 'üöÄ Run Test Again';
            }
        }

        // Disclaimer on page load
        window.addEventListener('load', () => {
            console.log('SIP ALG Test Tool loaded successfully');
            console.log('Note: Browser security restrictions limit direct port testing.');
            console.log('Results are based on indirect connectivity indicators.');
        });
    </script>
</body>
</html>
